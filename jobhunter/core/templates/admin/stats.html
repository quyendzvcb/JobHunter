{% extends "admin/base_site.html" %}

{% block content %}
<div style="padding: 20px;">
    <h1>Báo cáo Tổng quan Hệ thống</h1>

    <form method="GET"
        style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #ddd; display: flex; align-items: center; gap: 15px;">
        <label for="year"><strong>Chọn năm báo cáo:</strong></label>
        <select name="year" id="year" onchange="this.form.submit()"
            style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ccc;">
            {% for y in year_options %}
            <option value="{{ y }}" {% if y==selected_year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
    </form>

    <div style="display: flex; gap: 20px; margin-bottom: 40px; flex-wrap: wrap;">
        <div
            style="flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #3498db;">
            <h3 style="margin: 0; font-size: 14px; color: #7f8c8d; text-transform: uppercase;">Nhà tuyển dụng</h3>
            <p style="font-size: 28px; font-weight: bold; margin: 10px 0; color: #2c3e50;">{{ kpi.recruiters }}</p>
        </div>

        <div
            style="flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #e67e22;">
            <h3 style="margin: 0; font-size: 14px; color: #7f8c8d; text-transform: uppercase;">Ứng viên</h3>
            <p style="font-size: 28px; font-weight: bold; margin: 10px 0; color: #2c3e50;">{{ kpi.applicants }}</p>
        </div>

        <div
            style="flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #2ecc71;">
            <h3 style="margin: 0; font-size: 14px; color: #7f8c8d; text-transform: uppercase;">Tin đăng ({{
                selected_year }})</h3>
            <p style="font-size: 28px; font-weight: bold; margin: 10px 0; color: #2c3e50;">{{ kpi.jobs }}</p>
        </div>

        <div
            style="flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #e74c3c;">
            <h3 style="margin: 0; font-size: 14px; color: #7f8c8d; text-transform: uppercase;">Doanh thu ({{
                selected_year }})</h3>
            <p style="font-size: 28px; font-weight: bold; margin: 10px 0; color: #c0392b;">{{ kpi.revenue }} <span
                    style="font-size: 14px; color: #7f8c8d;">VNĐ</span></p>
        </div>
    </div>

    <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h2 style="margin: 0;">Biểu đồ Phân tích</h2>

            <div style="display: flex; gap: 15px;">
                <div>
                    <label for="dataTypeSelector"><strong>Dữ liệu:</strong> </label>
                    <select id="dataTypeSelector" onchange="updateChart()"
                        style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="apps">Lượt ứng tuyển</option>
                        <option value="jobs">Tin đăng mới</option>
                        <option value="revenue">Doanh thu</option>
                    </select>
                </div>

                <div>
                    <label for="chartTypeSelector"><strong>Kiểu:</strong> </label>
                    <select id="chartTypeSelector" onchange="updateChart()"
                        style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="bar">Cột (Bar)</option>
                        <option value="line">Đường (Line)</option>
                    </select>
                </div>
            </div>
        </div>

        <canvas id="mainChart" height="100"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartLabels = {{ chart_labels|safe }};

    const allData = {
        apps: {
            label: 'Số lượt ứng tuyển',
            data: {{ chart_data_apps|safe }},
            color: 'rgba(54, 162, 235, 1)',
            bgColor: 'rgba(54, 162, 235, 0.5)'
        },
        jobs: {
            label: 'Số tin đăng mới',
            data: {{ chart_data_jobs|safe }},
            color: 'rgba(46, 204, 113, 1)',
            bgColor: 'rgba(46, 204, 113, 0.5)'
        },
        revenue: {
            label: 'Doanh thu (VNĐ)',
            data: {{ chart_data_revenue|safe }},
            color: 'rgba(231, 76, 60, 1)',
            bgColor: 'rgba(231, 76, 60, 0.5)'
        }
    };

    let myChart = null;

    function updateChart() {
        const typeSelector = document.getElementById('chartTypeSelector');
        const dataSelector = document.getElementById('dataTypeSelector');

        const type = typeSelector.value;
        const dataKey = dataSelector.value;
        const selectedData = allData[dataKey];

        const ctx = document.getElementById('mainChart').getContext('2d');

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: type,
            data: {
                labels: chartLabels,
                datasets: [{
                    label: selectedData.label,
                    data: selectedData.data,
                    backgroundColor: selectedData.bgColor,
                    borderColor: selectedData.color,
                    borderWidth: 2,
                    fill: type === 'line',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                if (dataKey === 'revenue') {
                                    return value.toLocaleString('vi-VN') + ' đ';
                                }
                                return value;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (dataKey === 'revenue') {
                                    label += context.parsed.y.toLocaleString('vi-VN') + ' đ';
                                } else {
                                    label += context.parsed.y;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    updateChart();
</script>
{% endblock %}